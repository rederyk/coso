<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESP32-S3 Command Console</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: rgba(18, 26, 42, 0.9);
      --accent: #53f3c3;
      --text: #e8edf5;
      --muted: #9fb0c6;
      --danger: #ff7b7b;
      --success: #70ffba;
      --shadow: 0 18px 40px rgba(0, 0, 0, 0.4);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Space Grotesk", "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(83, 243, 195, 0.12), transparent 35%),
                  radial-gradient(circle at 80% 0%, rgba(98, 142, 255, 0.16), transparent 40%),
                  var(--bg);
      color: var(--text);
      padding: 24px;
    }
    main {
      max-width: 960px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    header {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: baseline;
      justify-content: space-between;
    }
    h1 {
      margin: 0;
      letter-spacing: 0.5px;
      font-size: 24px;
    }
    #status {
      color: var(--muted);
      font-size: 14px;
    }
    .panel {
      background: var(--panel);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 16px;
      padding: 16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
    }
    .command {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .command h3 {
      margin: 0;
      font-size: 17px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .badge {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--muted);
      font-size: 11px;
    }
    .desc {
      margin: 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.4;
    }
    .controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    input[type="text"] {
      flex: 1;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 10px 12px;
      color: var(--text);
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    input[type="text"]:focus {
      border-color: rgba(83, 243, 195, 0.6);
      box-shadow: 0 0 0 3px rgba(83, 243, 195, 0.18);
    }
    button {
      background: linear-gradient(135deg, #62b4ff, #53f3c3);
      color: #0b1220;
      border: none;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 12px 22px rgba(83, 243, 195, 0.22);
      transition: transform 0.12s ease, box-shadow 0.2s ease;
    }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); box-shadow: none; }
    pre {
      margin: 0;
      padding: 12px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 12px;
      color: #d7ffe8;
      font-size: 13px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .result {
      display: none;
      flex-direction: column;
      gap: 6px;
    }
    .result.active { display: flex; }
    .label {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }
    @media (max-width: 540px) {
      body { padding: 14px; }
      header { flex-direction: column; align-items: flex-start; }
      .controls { flex-direction: column; }
      button { width: 100%; }
    }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>ESP32-S3 Command Console</h1>
      <div id="status">Loading commands…</div>
    </header>

    <section class="panel" id="health-panel">
      <div class="label">System health</div>
      <div id="health" style="margin-top:6px;color:var(--muted);font-size:14px;">Waiting for data…</div>
    </section>

    <section class="panel">
      <div class="label">Available commands</div>
      <div id="commands" class="grid" style="margin-top:10px;"></div>
    </section>
  </main>

  <script>
    async function fetchJson(url, options) {
      const res = await fetch(url, options);
      const data = await res.json();
      return { ok: res.ok, data };
    }

    async function loadHealth() {
      try {
        const { ok, data } = await fetchJson('/api/health');
        if (!ok) throw new Error('Health request failed');
        const health = document.getElementById('health');
        const wifi = data.wifi || {};
        const heap = data.heap || {};
        const sd = data.sd || {};
        health.innerHTML = `
          WiFi: <strong>${wifi.connected ? 'connected' : 'disconnected'}</strong> ${wifi.ssid ? '(' + wifi.ssid + ')' : ''} · IP: ${wifi.ip || 'n/a'}<br>
          Heap: ${heap.free || 0} free / largest ${heap.largest_block || 0} · PSRAM free ${heap.psram_free || 0}<br>
          SD: ${sd.mounted ? 'mounted' : 'not mounted'} ${sd.total ? ' · total ' + sd.total : ''} ${sd.used ? ' · used ' + sd.used : ''}
        `;
      } catch (e) {
        document.getElementById('health').textContent = 'Failed to load health data';
      }
    }

    async function loadCommands() {
      const status = document.getElementById('status');
      try {
        const { ok, data } = await fetchJson('/api/commands');
        if (!ok) throw new Error('HTTP error');
        renderCommands(data.commands || []);
        status.textContent = `Loaded ${data.commands?.length || 0} commands`;
      } catch (err) {
        status.textContent = 'Failed to load commands';
      }
    }

    function renderCommands(commands) {
      const container = document.getElementById('commands');
      container.innerHTML = '';
      commands.forEach((cmd) => {
        const card = document.createElement('div');
        card.className = 'command panel';
        card.innerHTML = `
          <h3>${cmd.name} <span class="badge">command</span></h3>
          <p class="desc">${cmd.description || 'No description'}</p>
          <div class="controls">
            <input type="text" placeholder="Arguments separated by space" aria-label="Arguments">
            <button>Run</button>
          </div>
          <div class="result">
            <div class="label">Result</div>
            <pre></pre>
          </div>
        `;
        const input = card.querySelector('input');
        const button = card.querySelector('button');
        const resultBlock = card.querySelector('.result');
        const pre = card.querySelector('pre');

        button.addEventListener('click', async () => {
          button.disabled = true;
          button.textContent = 'Running…';
          pre.textContent = '';
          resultBlock.classList.remove('active');
          const args = input.value.trim().length ? input.value.trim().split(/\s+/) : [];
          const payload = { command: cmd.name, args };
          try {
            const res = await fetch('/api/commands/execute', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            const data = await res.json();
            pre.textContent = data.message || (data.status === 'success' ? 'OK' : 'Failed');
            pre.style.color = res.ok ? '#d7ffe8' : 'var(--danger)';
            resultBlock.classList.add('active');
          } catch (e) {
            pre.textContent = 'Request failed';
            pre.style.color = 'var(--danger)';
            resultBlock.classList.add('active');
          } finally {
            button.disabled = false;
            button.textContent = 'Run';
          }
        });

        container.appendChild(card);
      });
    }

    loadCommands();
    loadHealth();
    setInterval(loadHealth, 5000);
  </script>
</body>
</html>
